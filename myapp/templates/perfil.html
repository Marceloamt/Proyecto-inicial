{% extends 'base.html' %}
{% block title %}Perfil | HomeBalance{% endblock %}

{% block content %}
<main style="padding: 40px; max-width: 1200px; margin: 0 auto;">

    {% if messages %}
        <div class="mensajes">
            {% for message in messages %}
                <div class="alert alert-{{ message.tags }}">{{ message }}</div>
            {% endfor %}
        </div>
    {% endif %}

    <h2>üë§ Perfil de {{ usuario.username|default:"Usuario" }}</h2>

    <div class="perfil-edicion-card familia-card" style="margin-bottom: 20px;">
        <h3>üéÇ Datos Personales</h3>
        
        {# Correcci√≥n de edad para mostrar "No registrada" si es None #}
        <p><strong>Edad (calculada):</strong> {{ perfil.edad|default:"No registrada" }} a√±os</p>

        <form method="post" class="form-perfil">
            {% csrf_token %}
            
            {# Asumiendo que 'form' contiene PerfilForm (fecha_nacimiento) #}
            {{ form.as_p }} 

            <button type="submit" class="btn btn-crear">üíæ Guardar Fecha de Nacimiento</button>
        </form>
    </div>
    <div class="botones-gestion" style="display: flex; gap: 20px; margin-bottom: 30px; padding: 0; border: none; justify-content: center;">
        
        {# Bot√≥n de UNIRSE: Visible siempre #}
        <a href="{% url 'unirse_familia' %}" class="btn btn-unirse" style="background-color: #2196F3; border: none;">üîë Unirse con c√≥digo</a>
    
        {# Bot√≥n de CREAR: Visible siempre #}
        <a href="{% url 'crear_familia' %}" class="btn btn-crear" style="background-color: #4CAF50; border: none;">üè° Crear mi familia</a>
</div>
    </div>


    {% if familia %}
        <div class="familia-card">
            <h3>üè° Familia: <span>{{ familia.nombre }}</span></h3>

            {% if es_jefe %}
                <p><strong>Rol:</strong> Jefe/a de hogar</p>
                <p>
                    <strong>C√≥digo de invitaci√≥n:</strong>
                    <span id="codigo">{{ familia.codigo_invitacion }}</span>
                    <button onclick="copiarCodigo()" class="btn">üìã Copiar c√≥digo</button>
                </p>
                <a href="{% url 'invitar_miembro' %}" class="btn">‚ûï Invitar miembros</a>
            {% else %}
                <p><strong>Rol:</strong> Miembro del hogar</p>
                <p><strong>Jefe/a de familia:</strong> {{ familia.jefe.username }}</p>
                <p><strong>Otros miembros:</strong>
                    {% if miembros %}
                        {{ miembros|join:", " }}
                    {% else %}
                        (no hay otros miembros)
                    {% endif %}
                </p>
            {% endif %}

            <div class="horario-boton">
                <a href="{% url 'agregar_horario' %}" class="btn btn-success">üïí Agregar horario disponible</a>
                <a href="{% url 'ver_horario' %}" class="btn">üóìÔ∏è Ver mis horarios</a>
            </div>
        </div>
    {% else %}
        <p class="alert alert-info">A√∫n no tienes una familia principal asignada.</p>
    {% endif %}

    <h3>üìÖ Calendario de Tareas y Disponibilidad</h3>
    <div id='calendar' style="margin-top: 20px;"></div>

    <hr>

    <h3>üïí Mis Horarios Registrados</h3>

    {% if horarios_disponibles %}
        <div class="horario-card">
            <table class="tabla-horarios">
                <thead>
                    <tr>
                        <th>D√≠a</th>
                        <th>Inicio</th>
                        <th>T√©rmino</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    {% for h in horarios_disponibles %}
                    <tr>
                        <td>{{ h.get_dia_display }}</td>
                        <td>{{ h.hora_inicio }}</td>
                        <td>{{ h.hora_termino }}</td>
                        <td>
                            <form action="{% url 'eliminar_horario' h.id %}" method="post" style="display:inline;">
                                {% csrf_token %}
                                <button type="submit" class="btn btn-danger btn-sm">üóëÔ∏è Eliminar</button>
                            </form>
                            <a href="{% url 'editar_horario' h.id %}" class="btn btn-outline-primary btn-sm">‚úèÔ∏è Editar</a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    {% else %}
        <p>No has registrado horarios disponibles. Usa el bot√≥n ‚ÄúAgregar horario disponible‚Äù.</p>
    {% endif %}

</main>

<link href="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css" rel="stylesheet" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/locales/es.js"></script>

<script>
function copiarCodigo() {
    const codigo = document.getElementById("codigo").textContent;
    navigator.clipboard.writeText(codigo);
    alert("C√≥digo copiado: " + codigo);
}

document.addEventListener('DOMContentLoaded', function() {
    const calendarEl = document.getElementById('calendar');
    const disponibilidad = JSON.parse('{{ disponibilidad_json|escapejs }}');
    const tareas = JSON.parse('{{ tareas_json|escapejs }}');

    const dias = { 'DOM': 0, 'LUN': 1, 'MAR': 2, 'MIE': 3, 'JUE': 4, 'VIE': 5, 'SAB': 6 };
    const eventos = [];

    // Disponibilidad
    for (let d in disponibilidad) {
        const dia = dias[d];
        disponibilidad[d].forEach(slot => {
            eventos.push({
                daysOfWeek: [dia],
                startTime: slot.inicio,
                endTime: slot.termino,
                display: 'background',
                color: '#87CEEB',
                title: 'Disponible'
            });
        });
    }

    // Tareas
    tareas.forEach(t => {
        eventos.push({
            title: 'TAREA: ' + t.nombre + ' (' + t.responsable + ')',
            start: moment(t.fecha_creacion).format('YYYY-MM-DD'),
            allDay: true,
            backgroundColor: '#dc3545',
            borderColor: '#dc3545'
        });
    });

    const calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        locale: 'es',
        height: 'auto',
        headerToolbar: {
            left: 'prev,next today',
            center: 'title',
            right: 'dayGridMonth,timeGridWeek,timeGridDay'
        },
        events: eventos
    });

    calendar.render();
});
</script>

<style>
h2 { color: #333; margin-bottom: 20px; }
.mensajes { margin-bottom: 20px; }
.alert { padding: 10px; border-radius: 6px; margin-bottom: 10px; }
.alert-success { background: #d4edda; color: #155724; }
.alert-error, .alert-danger { background: #f8d7da; color: #721c24; }

.familia-card {
    background-color: #f9f9f9;
    border: 2px solid #87CEEB;
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 20px;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
}
.familia-card span { color: #4CAF50; font-weight: bold; }

.btn {
    background-color: #87CEEB;
    color: white;
    padding: 10px 20px;
    border: none;
    border-radius: 8px;
    text-decoration: none;
    font-weight: bold;
    margin-top: 10px;
    display: inline-block;
    transition: 0.3s;
    cursor: pointer;
}
.btn:hover { background-color: #5bb8e0; }
.btn-crear { background-color: #4CAF50; }
.btn-crear:hover { background-color: #43a047; }
.btn-unirse { background-color: #2196F3; }
.btn-unirse:hover { background-color: #1976D2; }
.btn-success { background-color: #ffa726; }
.btn-success:hover { background-color: #fb8c00; }
.btn-danger { background-color: #e74c3c; color: white; border: none; padding: 4px 8px; border-radius: 6px; }
.btn-danger:hover { background-color: #c0392b; }
.btn-outline-primary {
    background: white; border: 1px solid #2196F3; color: #2196F3;
    padding: 4px 8px; border-radius: 6px; text-decoration: none;
}
.btn-outline-primary:hover { background-color: #2196F3; color: white; }
</style>
{% endblock %}