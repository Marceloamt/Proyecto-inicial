{% extends 'base.html' %}
{% block title %}Perfil | HomeBalance{% endblock %}

{% block content %}
<main style="padding: 40px; max-width: 1200px; margin: 0 auto;">

    {% if messages %}
        <div class="mensajes">
            {% for message in messages %}
                <div class="alert alert-{{ message.tags }}">{{ message }}</div>
            {% endfor %}
        </div>
    {% endif %}

    <h2>üë§ Perfil de {{ usuario.username|default:"Usuario" }}</h2>

    <div class="perfil-edicion-card familia-card" style="margin-bottom: 20px;">
        <h3>üéÇ Datos Personales</h3>
        
        {# Correcci√≥n de edad para mostrar "No registrada" si es None #}
        <p><strong>Edad (calculada):</strong> {{ perfil.edad|default:"No registrada" }} a√±os</p>

        <form method="post" class="form-perfil">
            {% csrf_token %}
            
            {# Asumiendo que 'form' contiene PerfilForm (fecha_nacimiento) #}
            {{ form.as_p }} 

            <button type="submit" class="btn-guardar-perfil">üíæ Guardar Fecha de Nacimiento</button>
        </form>
        
        <hr style="margin-top: 20px;">
        
        <div class="horario-boton" style="display: flex; gap: 20px; margin-top: 20px; justify-content: center;">
            <a href="{% url 'agregar_horario' %}" class="btn btn-horario-agregar">üïí Agregar horario disponible</a>
            <a href="{% url 'ver_horario' %}" class="btn btn-horario-ver">üóìÔ∏è Ver mis horarios</a>
        </div>
    </div>
    <div class="botones-gestion" style="display: flex; gap: 20px; margin-bottom: 30px; padding: 0; border: none; justify-content: center;">
        
        {# Bot√≥n de UNIRSE: Visible siempre #}
        <a href="{% url 'unirse_familia' %}" class="btn btn-unirse" style="background-color: #2196F3; border: none;">üîë Unirse con c√≥digo</a>
    
        {# Bot√≥n de CREAR: Visible siempre #}
        <a href="{% url 'crear_familia' %}" class="btn btn-crear" style="background-color: #4CAF50; border: none;">üè° Crear mi familia</a>
    </div>
    <hr>


    {% if familia %}
        <div class="familia-card">
            <h3>üè° Familia: <span>{{ familia.nombre }}</span></h3>

            {% if es_jefe %}
                <p><strong>Rol:</strong> Jefe/a de hogar</p>
                <p>
                    <strong>C√≥digo de invitaci√≥n:</strong>
                    <span id="codigo">{{ familia.codigo_invitacion }}</span>
                    <button onclick="copiarCodigo()" class="btn">üìã Copiar c√≥digo</button>
                </p>
                <a href="{% url 'invitar_miembro' %}" class="btn">‚ûï Invitar miembros</a>
                
                <p>
                    <strong>Miembros del Hogar:</strong>
                    <ul style="list-style-type: none; padding-left: 0; margin-top: 0px;">
                        <li style="font-weight: bold; color: #9429dc;">{{ usuario.username }} (T√∫ - Jefe/a)</li>
                        {% for miembro in miembros %}
                            <li>
                                {{ miembro.username }} 
                                <small style="color: #666;">(Edad: {{ miembro.perfil.edad|default:"N/A" }} a√±os)</small>
                            </li>
                        {% empty %}
                            <li>(Solo est√°s t√∫ en esta familia)</li>
                        {% endfor %}
                    </ul>
                </p>
                
                {# HERRAMIENTAS DE JEFE DE HOGAR (CENTRADO CORREGIDO) #}
                <div class="admin-tools mt-4" style="margin-top: 15px; display: flex; gap: 10px; justify-content: center;"> 
                    <a href="{% url 'repartir_tareas' familia.id %}" class="btn btn-success" style="background-color: #4CAF50;">
                        üîÑ Ejecutar Reparto de Tareas
                    </a>
                    
                    {# BOT√ìN CLAVE: Opci√≥n de Limpieza del Calendario #}
                    <a href="{% url 'limpiar_instancias_tareas' familia.id %}" class="btn btn-warning" style="background-color: #EF4444; color: #ffffff;">
                        üßπ Limpiar Tareas del Calendario
                    </a>
                </div>
                
            {% else %}
                <p><strong>Rol:</strong> Miembro del hogar</p>
                <p><strong>Jefe/a de familia:</strong> {{ familia.jefe.username }}</p>
                <p><strong>Otros miembros:</strong>
                    {% if miembros %}
                        {{ miembros|join:", " }}
                    {% else %}
                        (no hay otros miembros)
                    {% endif %}
                </p>
            {% endif %}

        </div>
    {% else %}
        <p class="alert alert-info">A√∫n no tienes una familia principal asignada.</p>
    {% endif %}

    <hr>

    <h3>üìÖ Calendario de Tareas y Disponibilidad</h3>
    <div id='calendar' style="margin-top: 20px;"></div>

    <hr>

    <h3>üïí Mis Horarios Registrados</h3>

    {% if horarios_disponibles %}
        <div class="horario-card">
            <table class="tabla-horarios">
                <thead>
                    <tr>
                        <th>D√≠a</th>
                        <th>Inicio</th>
                        <th>T√©rmino</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    {% for h in horarios_disponibles %}
                    <tr>
                        <td>{{ h.get_dia_display }}</td>
                        <td>{{ h.hora_inicio }}</td>
                        <td>{{ h.hora_termino }}</td>
                        <td>
                            <form action="{% url 'eliminar_horario' h.id %}" method="post" style="display:inline;">
                                {% csrf_token %}
                                <button type="submit" class="btn btn-danger btn-sm">üóëÔ∏è Eliminar</button>
                            </form>
                            <a href="{% url 'editar_horario' h.id %}" class="btn btn-outline-primary btn-sm">‚úèÔ∏è Editar</a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    {% else %}
        <p>No has registrado horarios disponibles. Usa el bot√≥n ‚ÄúAgregar horario disponible‚Äù.</p>
    {% endif %}

</main>

<link href="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css" rel="stylesheet" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/locales/es.js"></script>

<script>
function copiarCodigo() {
    const codigo = document.getElementById("codigo").textContent;
    // Usar document.execCommand para compatibilidad con iframe
    const tempInput = document.createElement("input");
    tempInput.value = codigo;
    document.body.appendChild(tempInput);
    tempInput.select();
    document.execCommand("copy");
    
    // Usar modal simple en lugar de alert()
    mostrarMensajeModal("C√≥digo de invitaci√≥n copiado: " + codigo);
}

// Implementaci√≥n de Modal simple (en lugar de alert())
function mostrarMensajeModal(mensaje) {
    const modalId = 'customAlertModal';
    let modal = document.getElementById(modalId);
    if (!modal) {
        modal = document.createElement('div');
        modal.id = modalId;
        modal.style.cssText = `
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.5); z-index: 1000; display: none; 
            align-items: center; justify-content: center;
        `;
        modal.innerHTML = `
            <div style="background: white; padding: 20px; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); max-width: 400px; text-align: center;">
                <p id="modalMessage" style="margin-bottom: 15px; font-weight: bold;"></p>
                <button onclick="document.getElementById('${modalId}').style.display='none'" style="background: #2196F3; color: white; padding: 8px 15px; border: none; border-radius: 6px; cursor: pointer;">Aceptar</button>
            </div>
        `;
        document.body.appendChild(modal);
    }
    document.getElementById('modalMessage').textContent = mensaje;
    modal.style.display = 'flex';
}

document.addEventListener('DOMContentLoaded', function() {
    const calendarEl = document.getElementById('calendar');
    
    // Si no hay familia, no hay nada que mostrar
    if (!calendarEl || !{{ familia|yesno:'true,false' }}) return;

    // Los datos ya vienen pre-formateados desde la vista (title, start, color)
    const tareasEventos = JSON.parse('{{ tareas_json|escapejs }}');
    const disponibilidad = JSON.parse('{{ disponibilidad_json|escapejs }}');

    const dias = { 'DOM': 0, 'LUN': 1, 'MAR': 2, 'MIE': 3, 'JUE': 4, 'VIE': 5, 'SAB': 6 };
    let eventos = [];
    
    // 1. A√±adir Tareas (usando el formato de la vista con fecha_vencimiento como 'start')
    eventos = eventos.concat(tareasEventos);


    // 2. A√±adir Disponibilidad (eventos de background)
    for (let d in disponibilidad) {
        const dia = dias[d];
        disponibilidad[d].forEach(slot => {
            eventos.push({
                daysOfWeek: [dia],
                startTime: slot.inicio,
                endTime: slot.termino,
                display: 'background',
                color: '#D0EFFF',
                title: 'Disponible'
            });
        });
    }

    const calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        locale: 'es',
        height: 'auto',
        headerToolbar: {
            left: 'prev,next today',
            center: 'title',
            right: 'dayGridMonth,timeGridWeek,timeGridDay'
        },
        events: eventos, // Usamos la lista combinada de eventos
        eventDisplay: 'block', // Mostrar el evento como un bloque
        eventDidMount: function(info) {
            // Estilo para el evento de tarea pendiente
            if (info.event.extendedProps.estado === 'pendiente') {
                 info.el.style.fontWeight = 'bold';
            }
        },
        // Manejo de eventos click (opcional, podr√≠as abrir un modal de detalle aqu√≠)
        eventClick: function(info) {
            mostrarMensajeModal(`Detalle de Tarea: ${info.event.title}`);
        }
    });

    calendar.render();
});
</script>

<style>
/* ... (Tus estilos existentes) ... */
h2 { color: #333; margin-bottom: 20px; }
.mensajes { margin-bottom: 20px; }
.alert { padding: 10px; border-radius: 6px; margin-bottom: 10px; }
.alert-success { background: #d4edda; color: #155724; }
.alert-error, .alert-danger { background: #f8d7da; color: #721c24; }

.familia-card {
    background-color: #f9f9f9;
    border: 2px solid #87CEEB;
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 20px;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
}
.familia-card span { color: #4CAF50; font-weight: bold; }

/* üîë AJUSTE CLAVE: UNIFICAR ALTURA CON PROPIEDADES EXPL√çCITAS (HEIGHT y line-height) */

/* 1. ESTILO GEN√âRICO DE BOT√ìN (BASE) */
.btn {
    background-color: #939598;
    color: white;
    /* Reducimos el padding vertical y usamos altura fija para uniformar */
    padding: 8px 20px; 
    border: none;
    border-radius: 8px;
    text-decoration: none;
    font-weight: bold;
    margin-top: 10px;
    /* Propiedades para asegurar la altura fija */
    display: inline-flex; /* Usar flex para centrar mejor el contenido */
    align-items: center;
    justify-content: center;
    height: 40px; /* ALTURA FIJA PARA TODOS */
    box-sizing: border-box; 
    transition: 0.3s;
    cursor: pointer;
    white-space: nowrap;
}
.btn:hover { background-color: #939598; }

/* 2. CLASE DE GUARDAR FECHA DE NACIMIENTO */
.btn-guardar-perfil {
    background-color: #939598; 
    color: white;
    padding: 8px 20px; /* Padding unificado */
    border: none;
    border-radius: 8px;
    font-weight: bold;
    cursor: pointer;
    transition: 0.3s;
    margin-top: 10px;
    /* Propiedades para asegurar la altura fija */
    display: inline-flex;
    align-items: center;
    justify-content: center;
    height: 40px; /* ALTURA FIJA PARA TODOS */
    box-sizing: border-box;
    white-space: nowrap;
}
.btn-guardar-perfil:hover {
    background-color: #939598; 
}


/* 3. BOTONES ESPEC√çFICOS (Aseguramos que hereden la altura de 40px) */

.btn-horario-agregar {
    background-color: #2563EB !important; 
    border-color: #2563EB;
    color: #ffffff !important; 
    /* El display: inline-flex y height: 40px ya vienen de .btn */
}
.btn-horario-agregar:hover {
    background-color: #2563EB !important;
}

.btn-horario-ver {
    background-color: #a8c3dd !important;
    border-color: #1E90FF;
    color: white !important;
    /* El display: inline-flex y height: 40px ya vienen de .btn */
}
.btn-horario-ver:hover {
    background-color: #a8c3dd !important;
}

/* 4. BOTONES DENTRO DE LA TABLA (Se quedan m√°s peque√±os para la tabla) */

.tabla-horarios .btn-sm {
    padding: 4px 8px; /* Reducido para la tabla */
    height: 30px; /* Altura m√°s peque√±a para la tabla */
    font-size: 14px; 
    margin: 0;
}

/* Resto de botones espec√≠ficos */
.btn-crear { background-color: #4CAF50; }
.btn-unirse { background-color: #2196F3; }
.btn-success { background-color: #ffa726; }
.btn-success:hover { background-color: #fb8c00; }
.btn-danger { background-color: #e74c3c; color: white; border: none; border-radius: 6px; }
.btn-danger:hover { background-color: #c0392b; }
.btn-outline-primary {
    background: white; border: 1px solid #2196F3; color: #2196F3;
    border-radius: 6px; text-decoration: none;
}
.btn-outline-primary:hover { background-color: #2196F3; color: white; }

</style>
{% endblock %}